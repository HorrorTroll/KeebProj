# Treadstone32ビルドガイド

## はじめに

　Treadstone32はすべてチップ部品を使っており、ピッチの細かい部品のはんだ付けがあるため自作キーボードの中でも難易度は高いです。まず使用する道具はちゃんとそろえてくださいますようお願いいたします。  
　また特にmicroUSBのピンとMCUのピンはピッチが狭いため、慣れないとハンダで隣のピンをブリッジすることがあります。これを気づかずに電源を入れると最悪部品をを破損しますので重ねてご注意くださいますようお願いいたします。  

## キット付属品

| 基板番号 | 定数 | 数 | 名前 | 備考 |
| ---- | ---- | --- | --- | --- |
| C1 | 0.1uF | 2 | コンデンサ(1206size) | プラスチックのリールケースに入っていて1uFよりも色が薄く、一番厚みがある |
| C2-C3 | 1uF | 3 | コンデンサ(1206size) | 一番色が濃い |
| C4-C5 | 22pF | 3 | コンデンサ(1206size) | 一番色が薄く、厚みも薄い |
| R1-R2 | 22ohm | 3 | 抵抗(1206size) | 22R0と書いてある |
| R3-R4 | 10Kohm | 3 | 抵抗(1206size) | 1002と書いてある |
| F1 | 500mA | 1 | リセッタブルヒューズ(0805size) | 4て書いてるもの |
| X1 | 16MHz | 1 | 水晶振動子 EPSON FA-238 | 裏にパッドが4つあって、表に薄く1600とか書いてある |
| U1 | - | 1 | MCU atmel ATMEGA32U4-AU |  |
| J1 | - | 1 | micro USB MOLEX 47642-0001 |  |
| (D1-D32) | - | 33 | 1N4148 SOD-123 | うっすらとシルク印刷されている |
| (SW1-SW32) | - | 32 | Kailh MX ソケット |  |
| Reset1 | - | 1 | リセットスイッチ |  |
| - | M2 8mm | 6 | 低頭ネジ（黒または銀） |
| - | M2 4mm | 6 | 低頭ネジ（銀） |
| - | M2 スペーサー 7mm | 6 | 丸型 全ねじスペーサー |
| - | 2mm | 5 | ゴム脚 |  |
| - | - | 1 | PCB | 基板 |
| - | - | 1 | マウントプレート | スイッチをはめ込むプレート |
| - | - | 1式 | アクリルケースパーツ | </br>2mmボトムプレート</br>2mmボトムミドル</br>5mmボトムミドル</br>5mmトップカバー |

※以下はアーリーバード版に含まれるネジとボルトです

| 基板番号 | 定数 | 数 | 名前 | 備考 |
| ---- | ---- | --- | --- | --- |
| - | M2 1.6mm | 6 | ナット |  |
| - | M2 17mm- | 6 | ボルト |  |

## キット以外に必要なもの

| 名前 | 数 | 備考 |
| ---- | ---- | --- |
| キースイッチ | 32個 | MX互換のもの |
| キーキャップ | 32個 | MX互換のもの |
| MicroUSBケーブル | 1個 |  |

### オプション

オプションでイルミネーション用LEDを取り付け可能です。  

| 名前 | 数 | 備考 |
| ---- | ---- | --- |
| LEDストリップ（WS2812B 6個付き） | 1個 | Underglow用（オプション） |

## 必要な道具

| 名前 | 備考 |
| ---- | ---- |
| 温調はんだごて | チップ部品は熱に弱いので温調はんだごてが必須です |
| 細めのこて先 | C型やD型で2φ以下のものを推奨。慣れている人ならなんでも |
| 糸ハンダ | 半田ブリッジを低減するため0.5mm程度の細いものを推奨します |
| フラックス | 必須です |
| フラックス除去剤 | フラックスを塗るのでそれの除去に使用します |
| ハンダ吸い取り線 | 失敗したとき、ハンダブリッジしたときに吸い取ります |
| ピンセット | 必須です |
| テスター | 接続確認、ブリッジしていないかの確認に必須です |
| キズミ、ルーペなど | MicroUSBやAtmega32U4のハンダブリッジを目視で確認する際に必要 |

## 組み立て

　組み立ての順序は出来れば難しいパーツから取り掛かります（最後に難しいパーツを取り付けて失敗したときの徒労感が半端ないので）。ただ最初からは厳しいと思いますので、素振りとしてダイオードを数個付けて身体と半田ごてを慣らしてからでも良いかと思います。  
　もし失敗してパーツや基板をダメにしてどうしようもない場合はBoothやTwitter、Discord等からご連絡ください。補修部品を販売いたします。  

## micro USBのはんだ付け

![img](_image/20190423-P4230004.jpg)  

　写真の向きで取り付けてください。  
　ハンダ付けするピンのピッチがかなり狭く、屋根の内側にピンがあるため難易度は高めです。  
　ここがショートしているとPCのUSBポートやUSBハブにダメージが出るおそれがあるので、ルーペやキズミでの目視確認し、テスターでの検査の両方で隣のピンと導通していないことを確認してください。（回路の設計上、隣同士のピンが導通しているのははんだをミスしています）  
　もし隣のピンと半田ブリッジている場合は半田吸い取り線などで除去してください。  

## atmega32u4のはんだ付け

![img](_image/20190423-P4230005.jpg)  

　写真の向きのように、atmega32u4のくぼんだ丸印と基板のシルクの丸印を同じ位置にします。  
　次にatmega32u4のピンが綺麗に載るように調整します。このとき、基板の銀色のパッドのどこか一辺にフラックスを軽く塗布しておくとちょっと吸いつくようになるので位置決めがしやすいと思います。  
　電源ピン回りがショートしているとPCのUSBポートやUSBハブにダメージが出るおそれがあるので、ルーペやキズミでの目視確認し、テスターでの検査の両方で隣のピンと導通していないことを確認してください。（回路の設計上、隣同士のピンは導通していないため、導通しているとハンダミスを疑ってください）  

　もし隣のピンとはんだブリッジている場合は半田吸い取り線などで除去してください。吸い取りにくい場合は、はんだを敢えて少し盛ってから一気に吸わせることで吸いやすくなる場合もあります。  

## 水晶振動子のはんだ付け

![img](_image/20190423-P4230006.jpg)  

　水晶振動子の印刷と、基板のX1が双方正しく読める位置にあわせてハンダ付けしてください。  

## コンデンサのはんだ付け

![img](_image/20190423-P4230007.jpg)  

　何も字が書いてなくて、グレーまたは茶色っぽい地味色なのがコンデンサです。  
　コンデンサはすべて積層セラミックで方向はありません。  

　22pFは色が薄く一番平たいものです。水晶振動子の両サイドC4,C5の二か所に取り付けます。  
　0.1uFはプラスチックケースに2個入っているものです。C1に取り付けます。
　残ったのは1uFです。C2,C3に取り付けます。  

## 抵抗のはんだ付け

　黒地に白で何か書いてあるのが抵抗です。これも方向はありません。  
　22R0(22Ω)はmicro USBの下にあるR1,R2に取り付けます。  
　1002(10kΩ)はリセットボタン付近とAtmega32U4付近にあるR3,R4に取り付けます。  

## リセットボタンのはんだ付け

　スイッチがReset1下の四角に収まる方向に取り付けてください。  

## リセッタブルヒューズのはんだ付け

　他と同様、方向はありません。F1に取り付けてください。  

## ダイオードのはんだ付け

　チップダイオードのシルクが薄く見えにくいですが、線が入っている方を基板の線が入っている方に向きを合わせて取り付けてください。  
　取り付け向きはすべて一定なので、一つ取り付けたら残りも同じ方向で取り付けていってください。  

![img](../../_image/diode02.png)  

## MXソケットのはんだ付け

　先にトッププレートにスイッチをすべてはめこみます。つぎにトッププレートとPCBを合わせます。スイッチ裏の中央の出っ張りをPCBの穴に合わせて取り付けてください。  
　MXソケットをPCBのシルクの白いマークに合わせて取り付けます。スイッチのピンがMXソケットにちゃんと刺さっている事を確認しながらパチパチと全部付けてください。  
　こうすることでMXソケットが浮かずに確実にはんだ付け出来ます。  

![img](_image/20190424-P4240008.jpg)  

　はんだごてを270℃程度に設定し、写真のようにMXソケットの端子に当てて3秒ほど温めます。  
![img](_image/20190424-P4240010.jpg)  

　はんだを写真のように差し込んで、横から同じ温度ではんだごてを差し込んで、はんだを溶かします。はんだが基板とMXソケットの間にスーッと入ったらはんだごてを離します。

![img](_image/20190424-P4240011.jpg)  

## ATm32U4DFUとして認識することを確認する

　ここまで出来たらもう一度、ルーペやキズミでの目視確認、テスターでの検査の両方で隣のピンと導通していないことmicroUSBとATMEGA32U4を対象によく確認してください。  
　確認出来たらPCとUSBケーブルで接続します。接続すると最初は(PCのOS問わず)ATm32U4という名前で認識します。  

windows10 デバイスマネージャでの表示  
![img](_image/20190424-085320.png)  

windows10 設定→デバイス→Bluetoothとその他のデバイスでの表示  
![img](_image/20190424-085401.png)  

　認識出来たらファームウェアを書き込むことが出来ます。  

　認識しない場合はどこかがハンダ不良で接続されていない可能性が高いです。以下を目視でチェックしてください。  

- 水晶振動子(X1)、コンデンサ(C1-C5)、抵抗(R1-R4)がキチンとはんだ付けされているか
- microUSBのピンがキチンとはんだ付けされているか
- ATMEGA32U4のピンがキチンとはんだ付けされているか

　付いていると思ってもいわゆるイモはんだっぽくなっていて接合されていないかもしれませんので、はんだを温めなおす、はんだを吸い取ってやり直してみてください。  

## *(オプション)UnderglowLEDをはんだ付けする*

　写真のようにテープLEDの剥離紙の両端数cmだけハサミなどでカットします。これはテープLEDの背面の端子と、キーボード基板のスルーホールなどの端子が接触して動作不良を起こすことを防ぐ意味合いがあります。  

![img](../../_image/led_tape.jpg)  

　テープLEDは向きがありテープLEDの端子と基板の端子が合う向きにします。
![img](_image/20190424-P4240023.jpg)  

### キーボード用ソフトウェアをatmega32u4に書き込む

　このキーボードはQMKというキーボード用のソフトウェアで動作するようにプログラミングしています。あらかじめ登録してあるdefaultキーマップは作者が実際に使用しているもので不自由なく使えるように工夫しています。

1. [QMK Toolbox](https://github.com/qmk/qmk_toolbox/releases)をダウンロードし、インストールします
2. [marksard/qmk_firmware_hex](https://github.com/marksard/qmk_firmware_hex/releases)にある最新のhexファイルからtreadstone32_rev1_via.zipをダウンロード、zipを展開します
3. QMK Toolboxの「open」ボタンをクリックして、先程展開しhexファイルを選択します
4. QMK Toolboxの「Auto-Flash」チェックボックスにチェックを入れてpromicro(直付けの場合は基板)をPCに接続し、リセットボタンを押して書き込みます。
   1. （リセットボタンをダブルクリックしないと書き込めないパターン、初回のみリセットボタンを押下しなくても書き込みが始まるのものもあります）

書き込み方法などはサリチル酸さんの[（初心者編）自作キーボードにファームウェアを書き込む](https://salicylic-acid3.hatenablog.com/entry/qmk-toolbox)の記事が参考になります。  

#### REMAPを使用する

　上記で書き込んだファイルはVIA対応ファームウェアで、ファームウェアを書き直さなくてもアプリケーション上からキー設定を変更することが出来ます。  
　ここでは国産のVIA対応キーマップ変更アプリケーションとして、WEB上からキーボードの設定が出来る[REMAP](https://remap-keys.app/)を紹介します。  
対応したキーボードを接続した状態で、「START REMAP FOR YOUR KEYBOARD」→「+KEYBOARD」ボタンを押下するとキーボード名が出ます。それを押下することでカスタマイズ画面が出てきます。  

詳しい操作方法などについては[初心者編）Remapを使ってキーマップを書き換えよう](https://salicylic-acid3.hatenablog.com/entry/remap-manual)の記事が参考になります。  

#### ビルド環境を作成する

　現状、以下のようなカスタムはソースファイルからビルドする必要があります。  

- ロータリエンコーダーの動作のカスタマイズ
- タップと長押しの判定タイミングを調整する
- OLED表示の内容を変更

　ソースからビルドが出来るようになると他の多彩な機能を扱え、細かい動作まで自在にカスタムすることが出来ます。  

[QMK　ビルド環境を準備する](https://docs.qmk.fm/#/ja/newbs_getting_started)  

　treadstone32のデフォルトキーマップは  
```qmk compile -kb treadstone32 -km default```
で可能です。書き込む場合は
```qmk flash -kb treadstone32 -km default```  
とすると、コンパイルが完了次第書き込み待ちになるので、その状態で基板にあるリセットボタンをクリック、もしくはダブルクリックで書き込みが始まります。  

## 動作確認を行う

　あとはケースを組み立ててキーキャップをつけるだけですが、ケースを組み立てるのと分解するのが若干面倒なのと、MXソケットやダイオードがキチンと半田付けされているかの動作確認を済ませておくとケース組み立てが一回で済むので、この時点でキースイッチやオプションのLEDが動作することを確認してください。  

### 動作確認

　デフォルトキーマップの場合、Lower、Raise（左親指キー、右親指キー）の順で押下するとAdjustレイヤーになります。押下したまま、Aキーを押下するとLEDのON/OFFです。光らない場合はLEDの取り付け向きやはんだ箇所をチェックしてください。  

## キーキャップの取り付け

　ケースの組み立て時、トップレイヤーとキーキャップが干渉しないように取り付ける必要があるので、先にキーキャップをハメ込んでください。  

## ケースの組み立て

　ケースのパーツは2mm厚のものと、5mm厚のものがあります。  
　2mmボトムプレートと2mmボトムレイヤーを合わせてみて、ボトムレイヤーにスペーサーをはめ込む場所が6箇所あります。その位置にボトムプレートへM2 4mmのネジで取り付けてください。  

![img](_image/20190717-P7170014.jpg)  

以下の順番で乗せていきます。  

| 層名 | 厚み | 上 |
| --- | --- | --- |
| トップレイヤー | 5mm |  |
| マウントプレート(PCB付) | 1.2mm |  |
| ミドルレイヤー | 5mm |  |
| ボトムレイヤー | 2mm |  |
| ボトムプレート | 2mm | 下 |

![img](_image/20190717-P7170016.jpg)  

　全部乗せたら、トップレイヤーの位置をキーキャップに干渉しないように位置を合わせながらM2 8mmネジで6箇所留めてください。
　ゴム脚は四隅と、2つの親指キーの間手前に一つ貼ってください。  
　添付のゴム脚の厚みは1.6mmのものです。気になるようでしたら追加でゴム脚を貼ってみてください。  

## 完成

　チェックして問題なさそうなら完成です！あなただけの一台に仕上げてください！  

![img](_image/20190424-P4240024.jpg)  

## キースイッチの交換方法

　手では取り外しにくいため、amazonなどで販売されているキースイッチ引き抜き工具を使用して交換してください。  
